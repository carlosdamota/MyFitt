rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es el dueño de los datos
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validadores de escritura
    function isValidRoutine() {
      return request.resource.data.title is string
        && request.resource.data.blocks is list
        && request.resource.data.blocks.size() <= 24;
    }

    function isValidAppData(docId) {
      return docId == "logs"
        ? request.resource.data.keys().hasOnly(["logs", "coachAdvice", "updatedAt"])
        : docId == "profile"
          ? request.resource.data.keys().hasOnly([
              "weight",
              "height",
              "age",
              "gender",
              "experienceLevel",
              "goal",
              "availableDays",
              "dailyTimeMinutes",
              "equipment",
              "dietType",
              "injuries",
              "activeRoutineId",
              "updatedAt"
            ])
          : false;
    }

    function isValidNutritionLog() {
      return request.resource.data.food is string
        && request.resource.data.calories is number
        && request.resource.data.protein is number
        && request.resource.data.carbs is number
        && request.resource.data.fats is number
        && request.resource.data.mealType in ["breakfast", "lunch", "dinner", "snack"]
        && request.resource.data.date is string;
    }

    // ==========================================
    // REGLAS DE SEGURIDAD
    // ==========================================
    
    // Datos de usuarios (PRIVADO - Solo el owner puede acceder)
    match /artifacts/{appId}/users/{userId}/routines/{routineId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidRoutine();
      allow delete: if isOwner(userId);
    }

    match /artifacts/{appId}/users/{userId}/app_data/{docId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidAppData(docId);
      allow delete: if isOwner(userId);
    }

    match /artifacts/{appId}/users/{userId}/nutrition_logs/{logId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidNutritionLog();
      allow delete: if isOwner(userId);
    }

    match /artifacts/{appId}/users/{userId}/billing/{docId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    // Rutinas compartidas (PÚBLICO para lectura, AUTENTICADO para escritura)
    match /artifacts/{appId}/shared_routines/{routineId} {
      // Cualquiera puede leer rutinas compartidas
      allow read: if true;
      
      // Solo usuarios autenticados pueden crear rutinas compartidas, 
      // y deben marcarse a sí mismos como autores
      allow create: if isAuthenticated() && 
        request.resource.data.originalAuthor == request.auth.uid &&
        isValidRoutine();
      
      // Solo el autor original puede modificar o eliminar su rutina compartida
      allow update: if isAuthenticated() && 
        resource.data.originalAuthor == request.auth.uid &&
        isValidRoutine();
      allow delete: if isAuthenticated() && 
        resource.data.originalAuthor == request.auth.uid;
    }
    
    // Rate Limits (deprecated, server-side only)
    match /artifacts/{appId}/rate_limits/{userId}/{action} {
      allow read, write: if false;
    }
    
    // Denegar acceso a cualquier otra colección no especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
