rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidRoutine() {
      return request.resource.data.title is string
        && request.resource.data.blocks is list
        && request.resource.data.blocks.size() <= 24;
    }

    function isValidAppData(docId) {
      return docId == "logs"
        ? request.resource.data.keys().hasOnly(["logs", "coachAdvice", "updatedAt"])
        : docId == "profile"
          ? request.resource.data.keys().hasOnly([
              "weight",
              "height",
              "age",
              "gender",
              "experienceLevel",
              "goal",
              "availableDays",
              "dailyTimeMinutes",
              "equipment",
              "dietType",
              "injuries",
              "activeRoutineId",
              "onboardingCompleted",
              "updatedAt",
              "email",
              "displayName",
              "emailOptOut",
              "pushEnabled",
              "lastWorkoutDate"
            ])
          : false;
    }

    function isValidNutritionLog() {
      return request.resource.data.food is string
        && request.resource.data.calories is number
        && request.resource.data.protein is number
        && request.resource.data.carbs is number
        && request.resource.data.fats is number
        && request.resource.data.mealType in ["breakfast", "lunch", "dinner", "snack"]
        && request.resource.data.date is string;
    }

    // ==========================================
    // REGLAS DE SEGURIDAD
    // ==========================================
    
    // Routines (PRIVATE)
    match /artifacts/{appId}/users/{userId}/routines/{routineId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidRoutine();
      allow delete: if isOwner(userId);
    }

    // App data: profile + logs (PRIVATE)
    match /artifacts/{appId}/users/{userId}/app_data/{docId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidAppData(docId);
      allow delete: if isOwner(userId);
    }

    // Nutrition logs (PRIVATE)
    match /artifacts/{appId}/users/{userId}/nutrition_logs/{logId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && isValidNutritionLog();
      allow delete: if isOwner(userId);
    }

    // Billing (READ-ONLY for client, server writes)
    match /artifacts/{appId}/users/{userId}/billing/{docId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }

    // FCM Tokens (PRIVATE - user can create/read/delete their own tokens)
    match /artifacts/{appId}/users/{userId}/fcm_tokens/{tokenId} {
      allow read, delete: if isOwner(userId);
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly(["token", "createdAt", "device"]);
    }

    // Notifications (PRIVATE - server writes, user reads)
    match /artifacts/{appId}/users/{userId}/notifications/{notificationId} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
    
    // Shared routines (PUBLIC read, AUTHENTICATED write with ownership)
    match /artifacts/{appId}/shared_routines/{routineId} {
      allow read: if true;
      
      allow create: if isAuthenticated() && 
        request.resource.data.originalAuthor == request.auth.uid &&
        isValidRoutine();
      
      allow update: if isAuthenticated() && 
        resource.data.originalAuthor == request.auth.uid &&
        isValidRoutine();
      allow delete: if isAuthenticated() && 
        resource.data.originalAuthor == request.auth.uid;
    }
    
    // Rate Limits (deprecated, server-side only)
    match /artifacts/{appId}/rate_limits/{userId}/{action} {
      allow read, write: if false;
    }
    
    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
